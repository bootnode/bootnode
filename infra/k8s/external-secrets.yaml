# External Secrets Operator configuration for Hanzo KMS
# This syncs secrets from Hanzo KMS to K8s without storing credentials in code
#
# Prerequisites:
# 1. Install External Secrets Operator: helm install external-secrets external-secrets/external-secrets -n external-secrets --create-namespace
# 2. Configure ClusterSecretStore with Hanzo KMS credentials
#
# Hanzo KMS Integration:
# - KMS URL: https://kms.hanzo.ai (or self-hosted)
# - Project: bootnode
# - Environment: production

---
# ClusterSecretStore - connects to Hanzo KMS
# Uses service token stored in hanzo-kms-credentials secret
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: hanzo-kms
spec:
  provider:
    # Hanzo KMS is Infisical-compatible
    # Use the Infisical provider with Hanzo KMS endpoint
    webhook:
      url: "https://kms.hanzo.ai/api/v3/secrets/raw"
      headers:
        Authorization:
          name: hanzo-kms-credentials
          namespace: external-secrets
          key: service-token
      result:
        jsonPath: "$.secrets"
      secrets:
        - name: env
          secretRef:
            name: hanzo-kms-credentials
            namespace: external-secrets
            key: environment
        - name: project
          secretRef:
            name: hanzo-kms-credentials
            namespace: external-secrets
            key: project-id
---
# ExternalSecret for Bootnode API
# Syncs secrets from Hanzo KMS to bootnode-secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: bootnode-secrets
  namespace: bootnode
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: hanzo-kms
    kind: ClusterSecretStore
  target:
    name: bootnode-secrets
    creationPolicy: Owner
  data:
    # Database credentials
    - secretKey: database-url
      remoteRef:
        key: DATABASE_URL
    - secretKey: database-url-go
      remoteRef:
        key: DATABASE_URL_GO
    # Redis
    - secretKey: redis-url
      remoteRef:
        key: REDIS_URL
    # Datastore (ClickHouse)
    - secretKey: datastore-url
      remoteRef:
        key: DATASTORE_URL
    # JWT & API Keys
    - secretKey: jwt-secret
      remoteRef:
        key: JWT_SECRET
    - secretKey: api-key-salt
      remoteRef:
        key: API_KEY_SALT
    # Optional: Bundler private key
    - secretKey: bundler-private-key
      remoteRef:
        key: BUNDLER_PRIVATE_KEY
---
# Setup instructions:
#
# 1. Create service token in Hanzo KMS:
#    - Go to https://kms.hanzo.ai
#    - Create project "bootnode"
#    - Add secrets: DATABASE_URL, REDIS_URL, JWT_SECRET, etc.
#    - Create service token with read access
#
# 2. Create K8s secret for KMS credentials:
#    kubectl create secret generic hanzo-kms-credentials \
#      -n external-secrets \
#      --from-literal=service-token='st.xxx.xxx' \
#      --from-literal=environment='production' \
#      --from-literal=project-id='xxx-xxx-xxx'
#
# 3. Apply this file:
#    kubectl apply -f external-secrets.yaml
#
# 4. Verify sync:
#    kubectl get externalsecret -n bootnode
#    kubectl get secret bootnode-secrets -n bootnode -o yaml
